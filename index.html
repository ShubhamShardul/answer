<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Be My Valentine ‚ù§Ô∏è</title>
<style>
  :root{
    --pink:#ff4d6d; --bg1:#fff6f8; --bg2:#ffe6eb; --muted:#7b7b7b;
    --card-w:380px; --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111}
  body{
    display:grid;place-items:center;
    background:linear-gradient(180deg,var(--bg1),var(--bg2));
    padding:18px;
  }
  .card{
    width:100%;max-width:var(--card-w);
    background:#fff;border-radius:var(--radius);padding:20px;
    box-shadow:0 14px 40px rgba(0,0,0,0.12);
    text-align:center;position:relative;
  }
  h1{margin:8px 0 12px;font-size:20px;line-height:1.25;color:var(--pink)}
  p.meta{margin:0 0 16px;color:var(--muted);font-size:13px}
  .actions{display:flex;gap:12px;justify-content:center;align-items:center}
  button{flex:1;padding:12px 10px;border-radius:12px;border:0;font-weight:700;font-size:15px;cursor:pointer}
  button:focus{outline:3px solid rgba(255,77,109,0.14)}
  .yes{background:var(--pink);color:#fff;box-shadow:0 8px 24px rgba(255,77,109,0.18)}
  .no{background:#f3f3f3;color:var(--muted);transition:transform .22s ease,opacity .22s ease}
  .no.deem{opacity:.5;transform:scale(.98)}
  .yes.pulse{transform:scale(1.04)}
  .row{display:flex;gap:8px;margin-top:12px;justify-content:center;align-items:center;flex-wrap:wrap}
  .pill{background:#fafafa;padding:7px 12px;border-radius:999px;font-size:13px;color:#444;border:1px solid #f0f0f0}
  .iconBtn{background:transparent;border:0;padding:6px 10px;border-radius:10px;cursor:pointer}
  .confettiCanvas{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:9999}
  .story {aspect-ratio:9/16;max-width:420px;padding:22px;border-radius:20px}
  @media (prefers-reduced-motion: reduce){
    .yes.pulse, .no {transition:none}
  }
  @media (max-width:420px){h1{font-size:18px}}
  /* Small footer text */
  .footer{margin-top:14px;font-size:12px;color:var(--muted)}
  .controls{display:flex;gap:8px;justify-content:center;align-items:center;margin-top:12px}
</style>
</head>
<body>
  <canvas id="confetti" class="confettiCanvas" aria-hidden="true"></canvas>

  <main class="card" id="card" role="application" aria-labelledby="q">
    <h1 id="q">Will you be my Valentine? ‚ù§Ô∏è</h1>
    <p class="meta" id="subtitle">A tiny question with big feelings ‚Äî you can say yes or no (I'll ask kindly).</p>

    <div class="actions" role="group" aria-label="Valentine choices">
      <button id="yesBtn" class="yes" aria-describedby="attempts">Yes üíò</button>
      <button id="noBtn" class="no" aria-describedby="attempts">No üôà</button>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="pill" id="attempts">Attempts: 0</div>
      <button id="shareBtn" class="pill iconBtn" title="Share">Share</button>
      <button id="resetBtn" class="pill iconBtn" title="Reset">Reset</button>
      <button id="toggleStory" class="pill iconBtn" title="Toggle story">Story</button>
    </div>

    <div class="controls" aria-hidden="true" style="margin-top:10px">
      <div class="footer">Tip: personalize the link with <code>?name=YourName</code></div>
    </div>

    <!-- Live region for screen readers -->
    <div aria-live="polite" aria-atomic="true" id="live" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden"></div>
  </main>

<script>
(() => {
  // ---------- Config & copy ----------
  const STATES = [
    "Will you be my Valentine? ‚ù§Ô∏è",
    "Are you sure? I‚Äôd really love it ü•∫",
    "I‚Äôll plan something special ‚ú®",
    "Chocolates + your favorite movie? üç´üé¨",
    "One last sweet ask‚Ä¶ please? üò≠‚ù§Ô∏è"
  ];
  const ANNOUNCES = [
    "Initial ask shown",
    "Gentle follow-up",
    "Promise: special plans",
    "Offer: chocolates and movie",
    "Final gentle ask"
  ];
  const LOCAL_KEY = "valentine_v2";

  // ---------- Elements ----------
  const qEl = document.getElementById('q');
  const yesBtn = document.getElementById('yesBtn');
  const noBtn = document.getElementById('noBtn');
  const attemptsEl = document.getElementById('attempts');
  const live = document.getElementById('live');
  const shareBtn = document.getElementById('shareBtn');
  const resetBtn = document.getElementById('resetBtn');
  const toggleStory = document.getElementById('toggleStory');
  const card = document.getElementById('card');
  const confettiCanvas = document.getElementById('confetti');
  const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  // ---------- State ----------
  let state = 0, attempts = 0, accepted = false, storyMode = false;
  // Personalization
  const params = new URLSearchParams(location.search);
  const person = (params.get('name') || '').trim();
  if(person) STATES[0] = `Hey ${person} ‚Äî will you be my Valentine? ‚ù§Ô∏è`;

  // Load persisted
  try {
    const s = JSON.parse(localStorage.getItem(LOCAL_KEY) || '{}');
    if(s && typeof s.state === 'number'){ state = s.state; attempts = s.attempts || 0; accepted = !!s.accepted; }
  } catch(e){ /* ignore */ }

  // ---------- Utilities ----------
  function persist(){ try{ localStorage.setItem(LOCAL_KEY, JSON.stringify({state,attempts,accepted})); }catch(e){} }
  function announce(i){ const msg = ANNOUNCES[Math.min(i,ANNOUNCES.length-1)] || qEl.textContent; live.textContent = msg; }
  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  // ---------- Render ----------
  function render(){
    qEl.textContent = STATES[clamp(state,0,STATES.length-1)];
    attemptsEl.textContent = `Attempts: ${attempts}`;
    if(accepted){
      yesBtn.classList.add('pulse'); noBtn.style.display = 'none';
      shareBtn.textContent = 'Share the joy';
      resetBtn.textContent = 'Reset';
    } else {
      yesBtn.classList.remove('pulse'); noBtn.style.display = 'inline-flex';
      if(state >= 2) noBtn.classList.add('deem'); else noBtn.classList.remove('deem');
      shareBtn.textContent = 'Share';
    }
  }

  // ---------- Confetti (canvas) ----------
  const ctx = confettiCanvas.getContext ? confettiCanvas.getContext('2d') : null;
  let confettiPieces = [];
  function resizeCanvas(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
  function spawnConfetti(count=40){
    if(prefersReduced || !ctx) return;
    confettiPieces = [];
    const colors = ['#ff4d6d','#ffd166','#06d6a0','#118ab2','#bd7efc'];
    for(let i=0;i<count;i++){
      confettiPieces.push({
        x: Math.random()*confettiCanvas.width,
        y: -10 - Math.random()*300,
        w: 6 + Math.random()*10,
        h: 8 + Math.random()*10,
        vx: -1 + Math.random()*2,
        vy: 2 + Math.random()*5,
        rot: Math.random()*360,
        vr: (-3 + Math.random()*6),
        color: colors[i % colors.length],
        life: 0
      });
    }
    confettiCanvas.style.display = 'block';
    requestAnimationFrame(tickConfetti);
    setTimeout(()=>{ confettiPieces = []; }, 3200);
  }
  function tickConfetti(){
    if(!ctx) return;
    ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    for(let p of confettiPieces){
      p.x += p.vx; p.y += p.vy; p.vy += 0.06; p.rot += p.vr; p.life += 1;
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot * Math.PI/180);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
    }
    // continue while pieces exist
    if(confettiPieces.length) requestAnimationFrame(tickConfetti);
    else { ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height); confettiCanvas.style.display='none'; }
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  // ---------- Sound: simple chime via WebAudio ----------
  let audioCtx = null;
  function playChime(){
    try {
      if(!window.AudioContext) return;
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      // two-tone chime
      const now = audioCtx.currentTime;
      const o1 = audioCtx.createOscillator();
      const o2 = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o1.type = 'sine'; o2.type = 'sine';
      o1.frequency.setValueAtTime(880, now); // A5
      o2.frequency.setValueAtTime(660, now); // E5
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.12, now + 0.005);
      g.gain.exponentialRampToValueAtTime(0.001, now + 1.2);
      o1.connect(g); o2.connect(g); g.connect(audioCtx.destination);
      o1.start(now); o2.start(now + 0.02);
      o1.stop(now + 1.05); o2.stop(now + 1.05);
    } catch(e){}
  }

  // ---------- Events ----------
  noBtn.addEventListener('click', () => {
    if(accepted) return;
    attempts++;
    state = clamp(state + 1, 0, STATES.length - 1);
    render();
    announce(state);
    persist();
    // lightweight micro-bump on No
    noBtn.animate([{transform:'translateY(0)'},{transform:'translateY(-6px)'},{transform:'translateY(0)'}],{duration:220, easing:'ease-out'});
    // analytics stub (non-blocking)
    navigator.sendBeacon && navigator.sendBeacon('/analytics/valentine', JSON.stringify({action:'no',state,attempts,time:Date.now()}));
  });

  yesBtn.addEventListener('click', () => {
    if(accepted) return;
    accepted = true;
    attempts++;
    render();
    announce('Accepted ‚Äî celebration!');
    persist();
    // show confetti and chime (gesture allowed)
    spawnConfetti(60);
    playChime();
    // gentle celebration animation
    yesBtn.animate([{transform:'scale(1)'},{transform:'scale(1.08)'},{transform:'scale(1)'}],{duration:600,easing:'cubic-bezier(.2,.8,.2,1)'});
    // analytics stub
    navigator.sendBeacon && navigator.sendBeacon('/analytics/valentine', JSON.stringify({action:'yes',state,attempts,time:Date.now()}));
  });

  // Keyboard: Enter triggers current focus or yes, Escape triggers no
  document.addEventListener('keyup', (e) => {
    if(e.key === 'Enter'){
      const active = document.activeElement;
      if(active === noBtn) noBtn.click(); else yesBtn.click();
    } else if(e.key === 'Escape'){
      noBtn.click();
    }
  });

  // Share
  shareBtn.addEventListener('click', async () => {
    const url = location.href;
    const shareText = person ? `${person}, you made my day ‚Äî will you be my Valentine?` : `I asked someone to be my Valentine ‚Äî try: ${url}`;
    if(navigator.share){
      try { await navigator.share({title:'Valentine',text:shareText,url}); return; } catch(e){}
    }
    // fallback copy
    try {
      await navigator.clipboard.writeText(url);
      alert('Link copied to clipboard ‚Äî share the love üíå');
    } catch(e){
      prompt('Copy this link to share:', url);
    }
  });

  // Reset
  resetBtn.addEventListener('click', () => {
    if(!confirm('Reset state and attempts?')) return;
    state = 0; attempts = 0; accepted = false;
    persist(); render(); announce(0);
  });

  // Story toggle
  toggleStory.addEventListener('click', () => {
    storyMode = !storyMode;
    if(storyMode) card.classList.add('story'); else card.classList.remove('story');
    toggleStory.textContent = storyMode ? 'Exit story' : 'Story';
  });

  // initial render & announce
  render();
  announce(state);

  // Expose debug/reset API
  window.__valentine = {
    state: () => ({state, attempts, accepted}),
    reset: () => { state=0; attempts=0; accepted=false; persist(); render(); announce(0); }
  };

  // Accessibility: ensure focus order and that buttons are reachable
  yesBtn.setAttribute('aria-label','Yes ‚Äî accept');
  noBtn.setAttribute('aria-label','No ‚Äî decline');

  // Persist periodically just in case
  setInterval(persist, 2000);

})();
</script>
</body>
</html>
