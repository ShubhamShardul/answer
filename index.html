<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EXTREMELY UNHINGED Valentine üíò (FIXED)</title>
<style>
  :root{ --bg1:#ff9aa2; --bg2:#ffd6e0; --accent:#ff4d6d; --muted:#6b6b6b; --card-w:380px; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:"Comic Sans MS", "Trebuchet MS", system-ui, Arial, sans-serif;}
  body{
    background: radial-gradient(circle at 10% 10%, #fff6f8, rgba(255,255,255,0)) , linear-gradient(180deg,var(--bg1),var(--bg2));
    display:grid;place-items:center;padding:20px;overflow:hidden;
  }
  .card{ width:100%;max-width:var(--card-w); background:#fff; border-radius:18px; padding:18px;
         box-shadow: 0 18px 50px rgba(0,0,0,0.18); text-align:center; position:relative; z-index:50; }
  h1{margin:6px 0 10px;color:var(--accent);font-size:20px}
  p.sub{margin:0 0 14px;color:var(--muted);font-size:13px}
  .row{display:flex;gap:10px;justify-content:center;align-items:center}
  button{ padding:12px 14px;border-radius:12px;border:0;font-weight:800;cursor:pointer;font-size:15px; }
  button:focus{outline:3px solid rgba(255,77,109,0.15)}
  .yes{background:var(--accent);color:#fff;box-shadow:0 10px 30px rgba(255,77,109,0.18)}
  .no{background:#f0f0f0;color:#333;position:relative}
  .control{background:#fff;border:1px solid #f0f0f0;padding:8px 10px;border-radius:999px;font-weight:700}
  .meter{width:100%;margin-top:12px}
  .meter input{width:100%}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;place-items:center;z-index:999}
  .modal{background:#fff;padding:18px;border-radius:12px;max-width:420px;width:90%;box-shadow:0 12px 40px rgba(0,0,0,0.3);text-align:left}
  .spinner{width:72px;height:72px;border-radius:50%;display:inline-grid;place-items:center;background:linear-gradient(135deg,#fff,#ffeef4);box-shadow:0 6px 18px rgba(0,0,0,0.08)}
  .dot{width:12px;height:12px;background:var(--accent);border-radius:50%;animation:blink .8s infinite ease-in-out}
  .dot:nth-child(2){animation-delay:.12s}
  .dot:nth-child(3){animation-delay:.24s}
  @keyframes blink{0%,100%{transform:scale(.6);opacity:.4}50%{transform:scale(1.1);opacity:1}}
  canvas#confetti{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:995}
  .heart{position:fixed;font-size:22px;pointer-events:none;z-index:996;animation:floatup 4s linear;}
  @keyframes floatup{from{transform:translateY(100vh) rotate(0);}to{transform:translateY(-20vh) rotate(360deg);opacity:0;}}
  .tiny{font-size:12px;color:#777;margin-top:8px}
  .termsBody{height:220px;overflow:auto;padding:8px;border-radius:8px;border:1px dashed #eee;background:#fafafa}
  .termLine{font-size:13px;line-height:1.4;padding:6px 0}
  .cat{font-size:18px;text-align:center}
  .cat svg{width:160px;height:160px;display:block;margin:0 auto}
  .big{font-size:34px;font-weight:900;color:var(--accent)}
  @media (max-width:420px){ .card{padding:16px} h1{font-size:18px} }
</style>
</head>
<body>

  <canvas id="confetti"></canvas>

  <div class="card" role="application" aria-labelledby="q">
    <h1 id="q">Will you be my Valentine? ‚ù§Ô∏è</h1>
    <p class="sub">Say "Yes" to end this glorious chaos ‚Äî try clicking "No" if you dare.</p>

    <div class="row" style="margin-bottom:8px">
      <button id="yesBtn" class="yes">Yes üíò</button>
      <button id="noBtn" class="no">No üôà</button>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="control tiny">Chaos</div>
      <div class="meter" style="flex:1">
        <input id="chaos" type="range" min="0" max="10" value="7" />
      </div>
      <div style="width:8px"></div>
      <button id="reset" class="control tiny">Reset</button>
    </div>

    <div class="tiny">Keyboard: <strong>Y</strong>=Yes, <strong>N</strong>=No, <strong>M</strong>=Meow</div>
  </div>

  <!-- spinner -->
  <div id="spinnerOverlay" class="overlay center" aria-hidden="true">
    <div class="modal center" style="flex-direction:column;">
      <div class="spinner" id="spinner">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>
      <div style="height:10px"></div>
      <div id="spinnerText" style="font-weight:700;color:#333">Processing your answer...</div>
    </div>
  </div>

  <!-- terms modal -->
  <div id="termsOverlay" class="overlay center" aria-hidden="true">
    <div class="modal">
      <h3>Terms & Conditions ‚Äî Important</h3>
      <p class="tiny">Please read the following terms carefully before you proceed. It's long. Very long.</p>
      <div class="termsBody" id="termsBody" tabindex="0" aria-label="terms"></div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button id="agreeBtn" class="control">I Agree</button>
        <button id="declineTerms" class="control">Nope</button>
      </div>
    </div>
  </div>

  <!-- cat -->
  <div id="catOverlay" class="overlay center" aria-hidden="true">
    <div class="modal center" style="flex-direction:column">
      <div class="cat">
        <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <g transform="translate(10,10)">
            <ellipse cx="50" cy="60" rx="34" ry="30" fill="#ffd6e0"/>
            <ellipse cx="30" cy="36" rx="8" ry="10" fill="#ffd6e0"/>
            <ellipse cx="70" cy="36" rx="8" ry="10" fill="#ffd6e0"/>
            <circle cx="40" cy="58" r="4" fill="#333"/>
            <circle cx="60" cy="58" r="4" fill="#333"/>
            <path d="M45 72 Q50 78 55 72" stroke="#cc4d6d" stroke-width="2" fill="none" stroke-linecap="round"/>
            <path d="M10 28 Q0 12 18 10 Q36 8 44 24" fill="#ffd6e0" />
            <path d="M90 28 Q100 12 82 10 Q64 8 56 24" fill="#ffd6e0" />
            <circle cx="50" cy="46" r="3" fill="#fff" opacity="0.6"/>
          </g>
        </svg>
        <div style="margin-top:10px;font-weight:800;color:#333">I brought treats. Say yes. üê±</div>
      </div>
      <div style="height:12px"></div>
      <div style="display:flex;gap:10px">
        <button id="catCuddle" class="yes">Cuddle</button>
        <button id="catPoke" class="control">Poke</button>
      </div>
    </div>
  </div>

<script>
/* FIXED and IMPROVED UNHINGED FILE
   - fixed recursion bug
   - clones that chase are "Yes" clones
   - Yes click now works (chime + confetti)
   - cleared intervals and improved robustness
*/

const $ = s => document.querySelector(s);

/* Elements */
const yesBtn = $('#yesBtn'), noBtn = $('#noBtn');
const chaos = $('#chaos'), resetBtn = $('#reset');
const spinnerOverlay = $('#spinnerOverlay'), spinnerText = $('#spinnerText');
const termsOverlay = $('#termsOverlay'), termsBody = $('#termsBody'), agreeBtn = $('#agreeBtn'), declBtn = $('#declineTerms');
const catOverlay = $('#catOverlay'), catCuddle = $('#catCuddle'), catPoke = $('#catPoke');
const confettiCanvas = document.getElementById('confetti'), qEl = $('#q');

let attempts = 0, yesCount = 0, termsAutoInterval = null;
let audioCtx = null;

/* small helpers */
const rand = (a,b) => a + Math.random() * (b - a);
const clamp = (v,a,b) => Math.max(a, Math.min(b, v));

/* Audio helpers */
function ensureAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function playTone(freq,dur=0.12,type='sine',vol=0.12){
  try {
    ensureAudio();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
    g.gain.setValueAtTime(vol, audioCtx.currentTime);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
    o.stop(audioCtx.currentTime + dur + 0.02);
  } catch(e){}
}
function boing(){ playTone(660,0.15,'sine',0.12); playTone(880,0.12,'sine',0.06); }
function pop(){ playTone(780,0.06,'square',0.14); }
function tada(){ playTone(880,0.14,'sine',0.12); playTone(660,0.22,'sine',0.12); playTone(1100,0.12,'sine',0.08); }

/* Confetti canvas (single implementation ‚Äî NO recursion) */
const ctx = confettiCanvas.getContext ? confettiCanvas.getContext('2d') : null;
let confettiPieces = [];
function resizeCanvas(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas); resizeCanvas();

function spawnConfetti(count=60){
  if(!ctx) return;
  confettiPieces = [];
  const colors = ['#ff4d6d','#ffd166','#06d6a0','#118ab2','#bd7efc','#ffd6e0'];
  for(let i=0;i<count;i++){
    confettiPieces.push({
      x: Math.random()*confettiCanvas.width,
      y: -10 - Math.random()*200,
      w: 6 + Math.random()*10,
      h: 8 + Math.random()*10,
      vx: -2 + Math.random()*4,
      vy: 2 + Math.random()*6,
      rot: Math.random()*360,
      vr: (-5 + Math.random()*10),
      color: colors[i % colors.length],
      life: 0
    });
  }
  requestAnimationFrame(tickConfetti);
}
function tickConfetti(){
  if(!ctx) return;
  ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  for(let p of confettiPieces){
    p.x += p.vx; p.y += p.vy; p.vy += 0.08; p.rot += p.vr; p.life += 1;
    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.rotate(p.rot * Math.PI/180);
    ctx.fillStyle = p.color;
    ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
    ctx.restore();
  }
  if(confettiPieces.some(p => p.y < confettiCanvas.height + 50)) requestAnimationFrame(tickConfetti);
  else ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
}

/* Hearts */
function launchHearts(rate=80){
  const burst = Math.floor(rate/4) + Math.floor(Math.random()*rate/3);
  for(let i=0;i<burst;i++){
    const e = document.createElement('div');
    e.className = 'heart';
    e.style.left = (Math.random()*90)+'vw';
    e.style.fontSize = (14 + Math.random()*34) + 'px';
    e.textContent = Math.random() > 0.6 ? 'üíñ' : '‚ù§Ô∏è';
    document.body.appendChild(e);
    setTimeout(()=> e.remove(), 4200 + Math.random()*2000);
  }
}
function emojiStorm(level=1){
  launchHearts(20 * level);
}

/* CLONE: clone the YES button and let it chase cursor ‚Äî this fixes "cursor followed by No" */
function spawnYesClone(){
  const base = yesBtn;
  const c = base.cloneNode(true);
  c.classList.add('clone');
  c.style.position = 'fixed';
  c.style.left = (Math.random()*(window.innerWidth-120)) + 'px';
  c.style.top = (Math.random()*(window.innerHeight-80)) + 'px';
  c.style.zIndex = 900;
  c.style.opacity = 0.95;
  c.textContent = 'Yes! üòç';
  document.body.appendChild(c);
  // chase pointer
  function chase(e){
    const rect = c.getBoundingClientRect();
    const dx = e.clientX - (rect.left + rect.width/2);
    const dy = e.clientY - (rect.top + rect.height/2);
    c.style.left = (rect.left + dx*0.12) + 'px';
    c.style.top = (rect.top + dy*0.12) + 'px';
  }
  window.addEventListener('mousemove', chase);
  c.addEventListener('click', ()=>{
    pop();
    c.remove();
    window.removeEventListener('mousemove', chase);
    yesBtn.click(); // clicking clones also triggers Yes
  });
  // auto remove after some time and cleanup
  setTimeout(()=> { try{ c.remove(); window.removeEventListener('mousemove', chase); }catch(e){} }, 9000 + Math.random()*7000);
}

/* Spinner prank */
let spinnerTimeout = null;
function showSpinnerPrank(){
  spinnerOverlay.style.display = 'grid';
  spinnerOverlay.setAttribute('aria-hidden','false');
  spinnerText.textContent = 'Processing your answer...';
  clearTimeout(spinnerTimeout);
  spinnerTimeout = setTimeout(() => {
    spinnerText.textContent = 'ERROR: You meant YES ‚Äî retrying...';
    pop();
    let flashes = 6;
    const f = setInterval(() => {
      yesBtn.style.background = (yesBtn.style.background ? '' : 'linear-gradient(90deg,#ffd6e0,#ff4d6d)');
      flashes--;
      if(flashes <= 0) { clearInterval(f); yesBtn.style.background=''; spinnerOverlay.style.display='none'; spinnerOverlay.setAttribute('aria-hidden','true');
          tada(); spawnConfetti(80); emojiStorm(clamp(Number(chaos.value),0,10)); }
    }, 220);
  }, 1000 + Math.random()*1200);
}

/* Terms modal: long content + auto-nudge (cleared when closed) */
function openTerms(){
  termsOverlay.style.display = 'grid';
  termsOverlay.setAttribute('aria-hidden','false');
  termsBody.innerHTML = '';
  for(let i=0;i<400;i++){
    const d = document.createElement('div'); d.className = 'termLine';
    d.textContent = `${i+1}. This is an important legal clause about feelings, chocolate & emojis. You agree to love, hugs, and occasional memes.`;
    termsBody.appendChild(d);
  }
  termsBody.scrollTop = 0;
  if(termsAutoInterval) clearInterval(termsAutoInterval);
  termsAutoInterval = setInterval(() => {
    if(termsOverlay.style.display !== 'grid'){ clearInterval(termsAutoInterval); termsAutoInterval = null; return; }
    // gently nudge back up to make it hard to reach bottom
    termsBody.scrollTop = Math.max(0, termsBody.scrollTop - 2);
  }, 120);
}

/* Cat popup */
function showCatPopup(){ catOverlay.style.display = 'grid'; catOverlay.setAttribute('aria-hidden','false'); boing(); }
function hideCatPopup(){ catOverlay.style.display = 'none'; catOverlay.setAttribute('aria-hidden','true'); }

/* Mischief on No click / hover */
let spawnChanceCounter = 0;
function mischiefNo(){
  attempts++;
  const level = clamp(Number(chaos.value), 0, 10);
  if(level >= 2) boing();
  if(level >= 6) pop();

  // move the no button somewhere
  const x = Math.random() * (window.innerWidth - 120);
  const y = Math.random() * (window.innerHeight - 80);
  noBtn.style.position = 'fixed';
  noBtn.style.left = x + 'px';
  noBtn.style.top = y + 'px';
  if(level > 5) { noBtn.style.transform = `rotate(${rand(-18,18)}deg)`; setTimeout(()=> noBtn.style.transform = '', 700); }

  // sometimes lie: temporarily say "Yes" then revert
  if(Math.random() > 0.7 && level >= 3){
    const old = noBtn.textContent;
    noBtn.textContent = Math.random() > 0.4 ? 'Yes üòÄ' : 'Maybe?';
    setTimeout(()=> { try{ noBtn.textContent = old; } catch(e){} }, 900 + Math.random()*1200);
  }

  // spawn a chasing YES clone occasionally (fix: clone is YES now)
  if(Math.random() * 100 < (25 + level*4)) spawnYesClone();

  // chance to show spinner prank or cat popup
  if(Math.random()*100 < (6 + level*6)) showSpinnerPrank();
  if(Math.random()*100 < (4 + level*5)) showCatPopup();

  // make Yes button do a little celebratory nudge
  yesBtn.animate([{transform:'scale(1)'},{transform:`scale(${1 + level*0.03})`},{transform:'scale(1)'}],{duration:340});
}

/* Event hooks */
noBtn.addEventListener('mouseover', ()=> mischiefNo());
noBtn.addEventListener('click', ()=> mischiefNo());
noBtn.addEventListener('mousemove', ()=> { if(Math.random() < 0.045) mischiefNo(); });

yesBtn.addEventListener('click', () => {
  ensureAudio();
  yesCount++;
  qEl.textContent = 'YAYYY!! üíñ You said YES!';
  tada(); spawnConfetti(120); emojiStorm(clamp(Number(chaos.value),0,10));
  for(let i=0;i<20;i++) setTimeout(()=> launchHearts(40), i*60);
  document.body.animate([{filter:'hue-rotate(0deg)'},{filter:'hue-rotate(360deg)'}],{duration:1800,iterations:1});
  setTimeout(()=> { noBtn.textContent = 'Okay fine üòÖ'; }, 800);
});

/* Terms modal actions */
agreeBtn.addEventListener('click', () => {
  spinnerOverlay.style.display='grid'; spinnerText.textContent = 'Applying your agreement...';
  setTimeout(()=> {
    spinnerText.textContent = 'ERROR: You scrolled the wrong way. You meant YES!';
    pop();
    setTimeout(()=> { spinnerOverlay.style.display='none'; spinnerOverlay.setAttribute('aria-hidden','true'); termsOverlay.style.display='none'; termsOverlay.setAttribute('aria-hidden','true'); clearInterval(termsAutoInterval); termsAutoInterval = null; showCatPopup(); }, 1200);
  }, 1200);
});
declBtn.addEventListener('click', () => { pop(); alert("Declining terms causes more feelings. Try again."); });

catCuddle.addEventListener('click', () => { hideCatPopup(); yesBtn.click(); });
catPoke.addEventListener('click', () => { pop(); emojiStorm(4); spawnYesClone(); });

/* Chaos meter */
chaos.addEventListener('input', ()=> { pop(); });

/* Keyboard shortcuts */
document.addEventListener('keydown', (e) => {
  const k = e.key.toLowerCase();
  if(k === 'y') yesBtn.click();
  if(k === 'n') noBtn.click();
  if(k === 'm') { showCatPopup(); boing(); }
  if(k === 'u'){ chaos.value = 10; chaos.dispatchEvent(new Event('input')); setTimeout(()=> { spawnConfetti(300); emojiStorm(10); }, 200); }
});

/* Reset */
resetBtn.addEventListener('click', () => {
  document.querySelectorAll('.clone').forEach(n=>n.remove());
  document.querySelectorAll('.heart').forEach(n=>n.remove());
  spinnerOverlay.style.display='none'; spinnerOverlay.setAttribute('aria-hidden','true');
  termsOverlay.style.display='none'; termsOverlay.setAttribute('aria-hidden','true');
  catOverlay.style.display='none'; catOverlay.setAttribute('aria-hidden','true');
  attempts = 0; yesCount = 0;
  qEl.textContent = 'Will you be my Valentine? ‚ù§Ô∏è';
  noBtn.style.left=''; noBtn.style.top=''; noBtn.textContent='No üôà'; noBtn.style.transform=''; noBtn.style.position='relative';
  pop();
  if(termsAutoInterval){ clearInterval(termsAutoInterval); termsAutoInterval = null; }
});

/* initial nudges */
setTimeout(()=> { if(Math.random() > 0.4) mischiefNo(); }, 900);
setTimeout(()=> { launchHearts(20); }, 600);

</script>
</body>
</html>
